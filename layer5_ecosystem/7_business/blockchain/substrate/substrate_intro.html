<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Substrate介绍与解析 - Programming Anatomy In Rust 🦀</title>
    <!-- Custom HTML head -->
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="以rust为例分享学习编程常考虑的方方面面">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
    <link rel="stylesheet" href="../../../../css/variables.css">
    <link rel="stylesheet" href="../../../../css/general.css">
    <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">
    <!-- Fonts -->
    <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">
    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../../../../highlight.css">
    <link rel="stylesheet" href="../../../../tomorrow-night.css">
    <link rel="stylesheet" href="../../../../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="../../../../assets/css/mdbook-admonish.css">
        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "../../../../";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="../../../../overview.html"><strong aria-hidden="true">1.</strong> 总览</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/blockchain/substrate/substrate_intro.html" class="active"><strong aria-hidden="true">1.1.</strong> Substrate介绍与解析</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/layer1_underlying_abstract.html"><strong aria-hidden="true">2.</strong> Layer1: 底层抽象</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/1_virtual_memory/virtual_memory.html"><strong aria-hidden="true">2.1.</strong> 虚拟内存管理</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/1_virtual_memory/memory_manage_safety.html"><strong aria-hidden="true">2.1.1.</strong> 内存管理与内存安全</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/1_virtual_memory/ownership_borrow_lifetime.html"><strong aria-hidden="true">2.1.2.</strong> 所有权三件套</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/2_type_system/type_system.html"><strong aria-hidden="true">2.2.</strong> 类型系统</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/2_type_system/built_in_types.html"><strong aria-hidden="true">2.2.1.</strong> 基础内置类型</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/2_type_system/collections.html"><strong aria-hidden="true">2.2.2.</strong> 集合类型</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/2_type_system/user_defined_types.html"><strong aria-hidden="true">2.2.3.</strong> 自定义类型</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/2_type_system/generics_traits_objects.html"><strong aria-hidden="true">2.2.4.</strong> 泛型、特征及特征对象</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/language_grammar.html"><strong aria-hidden="true">2.3.</strong> 语言语法</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/annotation_rustdoc.html"><strong aria-hidden="true">2.3.1.</strong> 注释与文档(rustdoc)</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/keywords_glossary.html"><strong aria-hidden="true">2.3.2.</strong> 词法结构扫盲</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/binding_match_patterns.html"><strong aria-hidden="true">2.3.3.</strong> 绑定、赋值与匹配</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/logical_decision_loops.html"><strong aria-hidden="true">2.3.4.</strong> 逻辑判断与循环♻️</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/statements_expressions.html"><strong aria-hidden="true">2.3.5.</strong> 语句与表达式</a></li><li class="chapter-item expanded "><a href="../../../../layer1_underlying_abstract/3_language_grammar/code_quality.html"><strong aria-hidden="true">2.3.6.</strong> 代码质量</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/layer2_design_abstract.html"><strong aria-hidden="true">3.</strong> Layer2: 设计抽象</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/4_programming_paradigm/4_programming_paradigm.html"><strong aria-hidden="true">3.1.</strong> 编程范式</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/4_programming_paradigm/fp.html"><strong aria-hidden="true">3.1.1.</strong> 函数式编程</a></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/4_programming_paradigm/oop.html"><strong aria-hidden="true">3.1.2.</strong> 面向对象编程</a></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/4_programming_paradigm/gp.html"><strong aria-hidden="true">3.1.3.</strong> 泛型编程</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/5_design_pattern/5_design_pattern.html"><strong aria-hidden="true">3.2.</strong> 设计模式</a></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/6_module_manage/6_module_manage.html"><strong aria-hidden="true">3.3.</strong> 模块管理</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/6_module_manage/module_relate.html"><strong aria-hidden="true">3.3.1.</strong> 模块使用</a></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/6_module_manage/cargo_crate_lifetime.html"><strong aria-hidden="true">3.3.2.</strong> Cargo与项目生命周期</a></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/6_module_manage/cargo_rustc.html"><strong aria-hidden="true">3.3.3.</strong> Cargo run: rustc</a></li><li class="chapter-item expanded "><a href="../../../../layer2_design_abstract/6_module_manage/rust_plugins.html"><strong aria-hidden="true">3.3.4.</strong> Rust扩展工具</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer3_task_abstract/layer3_task_abstract.html"><strong aria-hidden="true">4.</strong> Layer3: 任务抽象</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer3_task_abstract/7_concurrency/7_concurrency.html"><strong aria-hidden="true">4.1.</strong> 并发编程</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer3_task_abstract/7_concurrency/io_models.html"><strong aria-hidden="true">4.1.1.</strong> 系统IO模型</a></li><li class="chapter-item expanded "><a href="../../../../layer3_task_abstract/7_concurrency/1_multi_models/multi_models.html"><strong aria-hidden="true">4.1.2.</strong> 多线程模型</a></li><li class="chapter-item expanded "><a href="../../../../layer3_task_abstract/7_concurrency/2_async_models/async_models.html"><strong aria-hidden="true">4.1.3.</strong> 异步模型</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer3_task_abstract/8_meta_programming/8_meta_programming.html"><strong aria-hidden="true">4.2.</strong> 元编程</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer4_protocol_abstract/layer4_protocol_abstract.html"><strong aria-hidden="true">5.</strong> Layer4: 协议抽象</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer4_protocol_abstract/9_multilingual_programming/9_multilingual_programming.html"><strong aria-hidden="true">5.1.</strong> 跨语言编程</a></li><li class="chapter-item expanded "><a href="../../../../layer4_protocol_abstract/10_computer_network/10_computer_network.html"><strong aria-hidden="true">5.2.</strong> 计算机网络</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/layer5_ecosystem.html"><strong aria-hidden="true">6.</strong> Layer5: 生态环境</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/1_learning_resource/learning_resource.html"><strong aria-hidden="true">6.1.</strong> 学习资源</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/1_learning_resource/1_books/books.html"><strong aria-hidden="true">6.1.1.</strong> 书籍整理</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/1_learning_resource/2_courses/courses.html"><strong aria-hidden="true">6.1.2.</strong> 线上课程</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/1_learning_resource/3_blogs/blogs.html"><strong aria-hidden="true">6.1.3.</strong> 博客文章</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/1_learning_resource/4_videos/videos.html"><strong aria-hidden="true">6.1.4.</strong> 在线视频</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/1_learning_resource/5_projects/projects.html"><strong aria-hidden="true">6.1.5.</strong> 开源项目</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/2_lang_update/lang_update.html"><strong aria-hidden="true">6.2.</strong> 官方动态</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/3_community/community.html"><strong aria-hidden="true">6.3.</strong> 社区热点</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/4_academic/academic.html"><strong aria-hidden="true">6.4.</strong> 学术讨论</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/open_source.html"><strong aria-hidden="true">6.5.</strong> 开源观察</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/1_underlying/underlying.html"><strong aria-hidden="true">6.5.1.</strong> 底层开发</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/1_underlying/command/command.html"><strong aria-hidden="true">6.5.1.1.</strong> 命令行工具</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/1_underlying/data/data.html"><strong aria-hidden="true">6.5.1.2.</strong> 数据处理</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/1_underlying/embedded/embedded.html"><strong aria-hidden="true">6.5.1.3.</strong> 嵌入式</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/1_underlying/os/os.html"><strong aria-hidden="true">6.5.1.4.</strong> 系统开发</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/1_underlying/performance/performance.html"><strong aria-hidden="true">6.5.1.5.</strong> 性能工具</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network.html"><strong aria-hidden="true">6.5.2.</strong> 网络相关</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/cloud/cloud.html"><strong aria-hidden="true">6.5.2.1.</strong> 云原生</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/frontend/frontend.html"><strong aria-hidden="true">6.5.2.2.</strong> 前端基建</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network/network.html"><strong aria-hidden="true">6.5.2.3.</strong> 网络基建</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network/ipfs/ipfs.html"><strong aria-hidden="true">6.5.2.3.1.</strong> IPFS: 星际文件系统(InterPlanetary File System)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network/ipfs/ipfs_website.html"><strong aria-hidden="true">6.5.2.3.1.1.</strong> 利用IPFS构建自己的去中心化分布式网站</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network/ipfs/ipfs_pubsub.html"><strong aria-hidden="true">6.5.2.3.1.2.</strong> IPFS pubsub功能</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network/ipfs/ipfs_companion.html"><strong aria-hidden="true">6.5.2.3.1.3.</strong> IPFS伴侣插件</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/network/ipfs/ipfs_ngrok.html"><strong aria-hidden="true">6.5.2.3.1.4.</strong> IPFS+ngrok</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/2_network/web/web.html"><strong aria-hidden="true">6.5.2.4.</strong> web开发</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/3_media/media.html"><strong aria-hidden="true">6.5.3.</strong> 多媒体</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/3_media/av/av.html"><strong aria-hidden="true">6.5.3.1.</strong> 音视频处理</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/3_media/game/game.html"><strong aria-hidden="true">6.5.3.2.</strong> 游戏开发</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/4_other/other.html"><strong aria-hidden="true">6.5.4.</strong> 其他</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/4_other/lang-with-rust/lang_with_rust.html"><strong aria-hidden="true">6.5.4.1.</strong> Rust与其他语言</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/4_other/scientific-research/scientific_research.html"><strong aria-hidden="true">6.5.4.2.</strong> 科学艺术研究</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/5_open_source/4_other/tools/tools.html"><strong aria-hidden="true">6.5.4.3.</strong> 其他工具</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/6_security/security.html"><strong aria-hidden="true">6.6.</strong> 安全参考</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/business.html"><strong aria-hidden="true">6.7.</strong> 商业观察</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/blockchain/blockchain.html"><strong aria-hidden="true">6.7.1.</strong> 区块链</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/blockchain/substrate/substrate_intro.html" class="active"><strong aria-hidden="true">6.7.1.1.</strong> Substrate介绍与解析</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/blockchain/nervos_ckb_anatomy.html"><strong aria-hidden="true">6.7.1.2.</strong> Nervos CKB介绍与解析</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/blockchain/solana.html"><strong aria-hidden="true">6.7.1.3.</strong> Solana</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/practices/practices.html"><strong aria-hidden="true">6.7.2.</strong> 生产实践</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/7_business/products/products.html"><strong aria-hidden="true">6.7.3.</strong> 优秀产品</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/8_libs/libs.html"><strong aria-hidden="true">6.8.</strong> 基础库</a></li><li class="chapter-item expanded "><a href="../../../../layer5_ecosystem/9_frameworks/frameworks.html"><strong aria-hidden="true">6.9.</strong> 框架引擎</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
        <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Programming Anatomy In Rust 🦀</h1>
            <h4 class="menu-bar"> -- 练武不练功 到头一场空 -- 《赛博英雄传》 </h4>
            <div class="right-buttons">
                    <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/programming_anatomy_in_rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>
        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="substrate介绍与源码解读"><a class="header" href="#substrate介绍与源码解读">Substrate介绍与源码解读</a></h1>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/what_is_substrate.png" alt="what_is_substrate" /></p>
<!--ts-->
<ul>
<li><a href="#substrate%E4%BB%8B%E7%BB%8D%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB">Substrate介绍与源码解读</a>
<ul>
<li><a href="#gavin-wookpolkadot-and-substrate">Gavin Wook、Polkadot and Substrate</a>
<ul>
<li><a href="#gavin-wook%E4%B8%8E%E6%B3%A2%E5%8D%A1%E8%B7%A8%E9%93%BE">Gavin Wook与波卡跨链</a></li>
<li><a href="#%E4%BB%8E%E6%B3%A2%E5%8D%A1%E5%88%B0substrate">从波卡到Substrate</a></li>
<li><a href="#%E8%B7%A8%E9%93%BE%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7">跨链的重要性</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1">总体设计</a>
<ul>
<li><a href="#%E5%B8%B8%E8%A7%81%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AE%BE%E8%AE%A1">常见区块链设计</a>
<ul>
<li><a href="#%E5%8C%BA%E5%9D%97%E9%93%BE%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86">区块链系统基础部分</a></li>
<li><a href="#%E9%93%BE%E7%9A%84%E5%8A%9F%E8%83%BD">链的功能</a></li>
<li><a href="#substrate%E7%90%86%E5%BF%B5">Substrate理念</a></li>
</ul>
</li>
<li><a href="#substrate-architecture">Substrate Architecture</a></li>
<li><a href="#%E5%BC%80%E5%8F%91%E8%80%85%E5%8F%AA%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8runtime%E9%93%BE%E5%8A%9F%E8%83%BD">开发者只需要关注Runtime(链功能)</a></li>
<li><a href="#%E6%98%8E%E6%99%B0runtime">明晰Runtime</a>
<ul>
<li><a href="#%E5%88%A4%E6%96%AD%E6%A0%87%E5%87%86">判断标准</a></li>
</ul>
</li>
<li><a href="#substrate%E7%9A%84runtime">Substrate的Runtime</a>
<ul>
<li><a href="#%E4%B8%AD%E5%BF%83%E5%8C%96%E5%8D%87%E7%BA%A7%E6%B5%81%E7%A8%8B">中心化升级流程</a></li>
<li><a href="#%E6%97%A0%E5%A4%AE%E5%8C%96%E5%8D%87%E7%BA%A7%E6%B5%81%E7%A8%8B%E5%8E%9F%E5%85%88">无央化升级流程(原先)</a></li>
<li><a href="#substrate%E7%9A%84%E4%B8%8D%E5%90%8C">Substrate的不同</a></li>
<li><a href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E5%90%88%E7%BA%A6%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5">以太坊合约更新策略</a></li>
<li><a href="#substrate%E5%AF%B9%E5%BA%94%E5%90%88%E7%BA%A6%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5">Substrate对应‘合约更新策略’</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">项目结构</a>
<ul>
<li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9E%B6%E6%9E%84">客户端架构</a></li>
<li><a href="#tree-level1">Tree Level1</a>
<ul>
<li><a href="#%E7%94%A8cargo%E7%BB%84%E7%BB%87%E4%BB%A3%E7%A0%81">用Cargo组织代码</a></li>
</ul>
</li>
<li><a href="#bin">bin:</a></li>
<li><a href="#client">client</a></li>
<li><a href="#frame">FRAME</a></li>
<li><a href="#primitives">primitives</a></li>
<li><a href="#scriptsci">scripts/ci</a></li>
<li><a href="#utils">utils</a></li>
</ul>
</li>
<li><a href="#%E5%8A%9F%E8%83%BD%E9%80%BB%E8%BE%91">功能逻辑</a></li>
<li><a href="#%E7%89%B9%E8%89%B2%E4%BB%A3%E7%A0%81">特色代码</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%BA%90">参考资源</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: kuanhsiaokuo, at: Tue Jun 21 15:22:32 CST 2022 -->
<!--te-->
<h2 id="gavin-wookpolkadot-and-substrate"><a class="header" href="#gavin-wookpolkadot-and-substrate">Gavin Wook、Polkadot and Substrate</a></h2>
<h3 id="gavin-wook与波卡跨链"><a class="header" href="#gavin-wook与波卡跨链">Gavin Wook与波卡跨链</a></h3>
<p>所以对于开发人员来说，比起大家耳熟能详的v神(Vitalik Buterin)，更重要的人是实际上撑起整个以太坊世界的灵魂人物<strong>Gavin Wood</strong>。更何况很多山寨币实际上就是在以太坊的模型上修修改改，所以在我看来Gavin
Wood是撑起了当前半个区块链世界的人。</p>
<p>而Gavin Wood 离开了以太坊之后，开启的一个新项目叫做Polkadot(波卡)，这个项目的<strong>目的就是跨链，为了把各个割裂的区块链孤岛能够联系一起</strong>
。虽然目前有很多的项目都号称自己在做跨链，但是目前在我看来唯一在推进，逻辑上是可推理，之后可能成功的跨链项目就只有波卡能够成功。（后半段可能存在一定误导性，Polkadot的跨链可能在大部分人理解下应该是分片的变种，也就是基于Substrate开发的区块链可以部署到Polkadot上，经过Polkadot平台互相沟通）。</p>
<h3 id="从波卡到substrate"><a class="header" href="#从波卡到substrate">从波卡到Substrate</a></h3>
<p>而Gavin Wood 在开发的波卡的过程中，经过不断地思考，认为其实区块链发展这几年，大家做的很多事情都是相同的。</p>
<div id="admonition-抽离共同点开始造轮子" class="admonition abstract">
<div class="admonition-title">
<p>抽离共同点，开始造&quot;轮子&quot;</p>
<p><a class="admonition-anchor-link" href="#admonition-抽离共同点开始造轮子"></a></p>
</div>
<div>
<p>那么在以往的软件开发中，当大家发现大家都在做相同的事情的时候，就会将这件事情进行抽象，然后造“轮子”，将这些高层次的东西做封装，成为“开发框架”，将背后复杂的基础设施都封装起来，而使用这个“框架”的开发人员，就可以更加专注于自己的业务逻辑，而不必花费大量的精力去造“轮子”去完成那些每个链都要做的事情。</p>
</div>
</div>
<p>Gavin Wood 在开发波卡的中途先暂停了波卡的开发，将波卡及以太坊已有的成果进行抽象，命名为substrate作为区块链开发的基础框架，并把全部精力都转移到了substrate开发中。</p>
<div id="admonition-第一个轮子" class="admonition tip">
<div class="admonition-title">
<p>第一个轮子</p>
<p><a class="admonition-anchor-link" href="#admonition-第一个轮子"></a></p>
</div>
<div>
<p>所以“substrate”就是区块链世界的第一个“轮子”。</p>
</div>
</div>
<h3 id="跨链的重要性"><a class="header" href="#跨链的重要性">跨链的重要性</a></h3>
<p>另一方面，在软件开发领域或者互联网领域，大家其实都发现了占据了框架的地位实际上一定程度上占据了这个领域开发的生态，更何况对于跨链来说，当大家的链都比较同质化后，跨链会更加的方便。现在大家都把跨链当作区块链下一个引爆点，而跨链的属性界定了做“跨链”的人基本上只能一家独大，成为垄断地位。而接入跨链的链越多，这个跨链就越垄断(
因为大家使用跨链就是为了在不同的链之间兑换代币，能换的代币越多，使用这个跨链的人就越多，生态就越集中)，</p>
<p>而Gavin Wood 提供的substrate框架又<strong>能解决大部分链都在重复解决的问题</strong>，所以大家就更倾向于使用substrate开发自己的链。</p>
<div id="admonition-三角关系" class="admonition quote">
<div class="admonition-title">
<p>三角关系</p>
<p><a class="admonition-anchor-link" href="#admonition-三角关系"></a></p>
</div>
<div>
<p>这样就会在“用户-链-跨链”这个三角关系中将三方的利益绑定在一起，互惠互利，共同进步。</p>
</div>
</div>
<h2 id="总体设计"><a class="header" href="#总体设计">总体设计</a></h2>
<h3 id="常见区块链设计"><a class="header" href="#常见区块链设计">常见区块链设计</a></h3>
<p>目前所有的区块链系统几乎都是从比特币/以太坊模型演变而来。一般来说，一个区块链系统应该具有：</p>
<h4 id="区块链系统基础部分"><a class="header" href="#区块链系统基础部分">区块链系统基础部分</a></h4>
<ul>
<li>共识系统 （区块链分布式基石）</li>
<li>p2p连接与广播系统</li>
<li>存储系统</li>
<li>交易池系统</li>
<li>rpc系统（区块链与外界交互主要通道）</li>
</ul>
<div id="admonition-基础通用" class="admonition info">
<div class="admonition-title">
<p>基础通用</p>
<p><a class="admonition-anchor-link" href="#admonition-基础通用"></a></p>
</div>
<div>
<p>基础部分是当前区块链模型下都会具备的组件，其中共识与P2P体现区块链的分布式本质</p>
</div>
</div>
<h4 id="链的功能"><a class="header" href="#链的功能">链的功能</a></h4>
<div id="admonition-竞争关键" class="admonition info">
<div class="admonition-title">
<p>竞争关键</p>
<p><a class="admonition-anchor-link" href="#admonition-竞争关键"></a></p>
</div>
<div>
<p>链功能是区块链间相互竞争的关键部分. 与系统基础部分相比，这部分差异很大，提供的是除去区块链模型外，这条链能够提供的功能。另一方面在区块链升级中，一般来说系统基础部分改动较小，而链的功能部分改动较大，特别是许多链为了追求开发速度，一开始只能提供转账功能，在后续的版本中才慢慢升级其他功能</p>
</div>
</div>
<p>例如：</p>
<ul>
<li>比特币的UTXO结构加上交易脚本</li>
<li>以太坊的虚拟机与智能合约</li>
<li>eos的账户系统及虚拟机</li>
<li>有的山寨币特化部分智能合约或部分native层成为系统级功能：
<ul>
<li>提供随机数</li>
<li>提供质押对赌</li>
<li>oracle数据输入</li>
<li>引入复杂密码学方案</li>
<li>等等。。。</li>
</ul>
</li>
</ul>
<h4 id="substrate理念"><a class="header" href="#substrate理念">Substrate理念</a></h4>
<div id="admonition-分离变与不变" class="admonition tip">
<div class="admonition-title">
<p>分离变与不变</p>
<p><a class="admonition-anchor-link" href="#admonition-分离变与不变"></a></p>
</div>
<div>
<p>Substrate作为一个区块链框架，认为所有的链都应该具备区块链系统基础部分，而由开发者自由定制链的功能部分</p>
</div>
</div>
<h3 id="substrate-architecture"><a class="header" href="#substrate-architecture">Substrate Architecture</a></h3>
<p>Gavin Wood 作为以太坊实际核心的开发者，自然早已对这套系统的框架了然于心，所以从Substrate框架提出的开始（2018年9月），就对区块链系统作出了2个关键的区分：</p>
<div id="admonition-coreruntime" class="admonition info">
<div class="admonition-title">
<p>Core&amp;Runtime</p>
<p><a class="admonition-anchor-link" href="#admonition-coreruntime"></a></p>
</div>
<div>
<p>Substrate Core: 系统基础部分
Runtime：链功能</p>
</div>
</div>
<div id="admonition-substrte-architecture" class="admonition tip">
<div class="admonition-title">
<p>Substrte Architecture</p>
<p><a class="admonition-anchor-link" href="#admonition-substrte-architecture"></a></p>
</div>
<div>
<pre><code class="language-text">┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                       │
│                                                                                                       │
│      ┌─────────────────┐     ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│      │ fund management │     │     Account     │    │    Contract     │    │   Democratic    │        │
│      │    transfer     │     │     system      │    │       VM        │    │   referendum    │        │
│      └─────────────────┘     └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│                                                                                                       │
│                                                  ######  #     # #     # ####### ### #     # #######  │
│      ┌─────────────────┐     ┌─────────────────┐ #     # #     # ##    #    #     #  ##   ## #        │
│      │     Equity      │     │      etc.       │ #     # #     # # #   #    #     #  # # # # #        │
│      │   calculation   │     │                 │ ######  #     # #  #  #    #     #  #  #  # #####    │
│      └─────────────────┘     └─────────────────┘ #   #   #     # #   # #    #     #  #     # #        │
│                                                  #    #  #     # #    ##    #     #  #     # #        │
│                                                  #     #  #####  #     #    #    ### #     # #######  │
├───────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                       │
│      ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐    ┌─────────────────┐       │
│      │    Consensus    │     │ Network system  │     │     Trading     │    │                 │       │
│      │    mechanism    │     │      (p2p)      │     │      Pool       │    │       RPC       │       │
│      └─────────────────┘     └─────────────────┘     └─────────────────┘    │                 │       │
│                                                                             └─────────────────┘       │
│                                                             #####  ####### ######  #######            │
│      ┌─────────────────┐                                   #     # #     # #     # #                  │
│      │      etc.       │                                   #       #     # #     # #                  │
│      │                 │                                   #       #     # ######  #####              │
│      └─────────────────┘                                   #       #     # #   #   #                  │
│                                                            #     # #     # #    #  #                  │
│                                                             #####  ####### #     # #######            │
│                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
</div>
</div>
<h3 id="开发者只需要关注runtime链功能"><a class="header" href="#开发者只需要关注runtime链功能">开发者只需要关注Runtime(链功能)</a></h3>
<p>根据这样的划分，当开发者使用Substrate框架的时候，无需关心区块链基础功能也就是Core部分的工作，而只需关心自己链能够提供的功能，也就是Runtime部分的工作。</p>
<div id="admonition-vm类似以太坊的智能合约" class="admonition tip">
<div class="admonition-title">
<p>VM类似以太坊的智能合约</p>
<p><a class="admonition-anchor-link" href="#admonition-vm类似以太坊的智能合约"></a></p>
</div>
<div>
<p>注意图中虚拟机EVM也是Runtime的一个组件。与以太坊的结构相比，相当于把以太坊的智能合约功能也能随意作为一个链的功能组件添加进入使用Substrate开发的链中</p>
</div>
</div>
<h3 id="明晰runtime"><a class="header" href="#明晰runtime">明晰Runtime</a></h3>
<p>这里一直强调Runtime是“链的功能”有一些通俗与不严谨，这里使用一个更抽象的描述：</p>
<div id="admonition-runtime明确" class="admonition danger">
<div class="admonition-title">
<p>Runtime明确</p>
<p><a class="admonition-anchor-link" href="#admonition-runtime明确"></a></p>
</div>
<div>
<p>需要对运行结果进行共识的功能部分应该归属于Runtime</p>
</div>
</div>
<p>这个定义比较抽象，且由于需要对“世界状态”或类似概念有比较深入的了解才好解释，故不展开讲解。更严格来说，“需要对运行结果进行共识的功能组件”是“链的功能”的一个子集。</p>
<h4 id="判断标准"><a class="header" href="#判断标准">判断标准</a></h4>
<div id="admonition-判断标准" class="admonition tip">
<div class="admonition-title">
<p>判断标准</p>
<p><a class="admonition-anchor-link" href="#admonition-判断标准"></a></p>
</div>
<div>
<p>这里有一个简单的判定标准判断某个功能是否应该放在Runtime内：</p>
<p>对于某个功能，若只改动一个节点的代码对于所有的逻辑运行的结果与其他不改动的节点运行的结果相同，则认为这个部分应该放在Runtime之外，如果运行结果不同，则认为应该放在Runtime之内。</p>
</div>
</div>
<div id="admonition-举例" class="admonition example">
<div class="admonition-title">
<p>举例</p>
<p><a class="admonition-anchor-link" href="#admonition-举例"></a></p>
</div>
<div>
<p>举个例子：比如我改变了交易池的排序代码，使得对某个账户有利的交易能优先打包。这个改动会令自己这个节点产出的区块不公平的打包交易，但是只要打包出来的区块大家都可以认可，则所有节点共识的“状态的变化”仍然是一致的。很明显，这个功能组件不应该是Runtime的功能，因为它不会改变对于验证一个区块时的“状态变化”的验证。比如我改变了转账功能的代码，能给某个账户凭空增加钱，那么显然，这种改动对于这个改动过的节点执行的结果将会与其他节点不同，则共识不会通过。所以转账这个功能就应该放在Runtime当中，让所有节点执行的都是一致的。</p>
</div>
</div>
<p>这部分结合native与wasm后会容易理解</p>
<p>所以到底什么是Runtime，我认为使用“链上功能”来描述最为恰当，因为其隐含了对于执行结果的共识问题。</p>
<h3 id="substrate的runtime"><a class="header" href="#substrate的runtime">Substrate的Runtime</a></h3>
<p>Substrate的Runtime当然没有止步于仅将区块链系统做了模块化划分，提供框架功能这一步，事实上，由于抽象出了Runtime，Substrate实现了以往所有区块链都无法实现的一个功能：区块链系统升级。</p>
<h4 id="中心化升级流程"><a class="header" href="#中心化升级流程">中心化升级流程</a></h4>
<div id="admonition-centralized-system-upgrading" class="admonition tip">
<div class="admonition-title">
<p>Centralized System Upgrading</p>
<p><a class="admonition-anchor-link" href="#admonition-centralized-system-upgrading"></a></p>
</div>
<div>
<pre><code class="language-text">┌────────────────────────────────Centralized System Upgrading(Internet App)────────────────────────────────┐
│                                                                                                          │
│                                                                                                          │
│                         ┌───────────────────┐      ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│                     ┌──▶│    Update Code    │      │   Deploy    │    │   Upgrade   │    │ Centralized │ │
│     .─────────.     │   │(Backend/Frontend)─┼──────▶   Server    │───▶│  Sucessful  │────▶Upgrade Easy │ │
│    ╱           ╲    │   └───────────────────┘      └─────────────┘    └─────────────┘    └─────────────┘ │
│   ( Bug/Upgrade )───┤                                                 ┌─────────────┐                    │
│    `.         ,'    │                                                 │  Somebody   │                    │
│      `───────'      │                                              ┌─▶│   Upgrade   ├─┐                  │
│                     │   ┌───────────────────┐      ┌─────────────┐ │  └─────────────┘ │  ┌─────────────┐ │
│                     └──▶│    Update Code    │      │   Publish   │ │                  │  │ Fragmented  │ │
│                         │       (App)      ─┼──────▶  App Store  │─┤  ┌─────────────┐ ├─▶│   version   │ │
│                         └───────────────────┘      └─────────────┘ │  │  Somebody   │ │  └─────────────┘ │
│                                                                    └─▶│   Reject    │─┘                  │
│                                                                       └─────────────┘                    │
│                                                                                                          │
│                                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
</div>
</div>
<p>对于中心化的互联网系统而言，由于代码与数据的控制权在自己手上，所以可以随时进行版本的升级与修改。但是即便如此，也只有网页H5，后台代码可以做到随时升级，在移动互联网中，app还是需要用户自行更新。其中android生态尤为突出，apk版本的碎片化一度是困扰开发者的难题。为了应对app应用的碎片化，推出了许多功能各异的框架能够用户在不更新app的情况下进行“热更新”，一度成为技术的热门追捧。这些热更新的框架本质上都是允许从后台下载一段更新代码，通过各种方式加载运行新的代码来完成。一般情况下通过这种热更新提供的功能都会带来一定的性能损耗以运行最新的热更新代码。但是即便是热更新，更新代码的控制权也同样处于中心化组织的手中。</p>
<h4 id="无央化升级流程原先"><a class="header" href="#无央化升级流程原先">无央化升级流程(原先)</a></h4>
<div id="admonition-decentralized-system-upgradingpre" class="admonition tip">
<div class="admonition-title">
<p>Decentralized System Upgrading(pre)</p>
<p><a class="admonition-anchor-link" href="#admonition-decentralized-system-upgradingpre"></a></p>
</div>
<div>
<pre><code class="language-text">┌───────────────────────────────────Decentralized System Upgrading(Blockchain Dapp)────────────────────────────────────┐
│                                                                                                 ┌─────────────┐      │
│                                                                                                 │   Upgrade   │      │
│                                                                                  ┌───Yes───────▶│  Sucessful  │      │
│                                                                                  │              └─────────────┘      │
│                                                                                  Λ                                   │
│                                                                                 ╱ ╲                                  │
│                                                                                ╱   ╲                                 │
│                                                                               ╱     ╲                                │
│                                                          ┌────────┐          ╱       ╲                               │
│                                                          │ Deploy │      Most deployments                            │
│                                              ┌──Support─▶│  Node  │─────▶(Under Byzantine                            │
│                                              │           └────────┘      Fault Tolerance)                            │
│                                              │                               ╲       ╱                               │
│                                              Λ                                ╲     ╱                                │
│                                             ╱ ╲                                ╲   ╱                                 │
│                                            ╱   ╲                                ╲ ╱                                  │
│                                           ╱     ╲                                V              ┌──────────────────┐ │
│     .─────────.      ┌─────────────┐     ╱       ╲                               │              │   Upgrade Fail   │ │
│    ╱           ╲     │ Update Node │    ╱ Running ╲                              └───No────────▶│(Cause Fragmented)│ │
│   ( Bug/Upgrade ─────▶    Code     ├────▶  Node    ▏                                            └──────────────────┘ │
│    `.         ,'     └─────────────┘    ╲ (Minner ╱                                                       ▲          │
│      `───────'                           ╲       ╱                                                        │          │
│                                           ╲     ╱                                                         │          │
│                                            ╲   ╱                                                          │          │
│     .─────────.                             ╲ ╱                                                           │          │
│  ,─'           '─.                           V                                                            │          │
│ ;    Community    :                          │           ┌────────┐                                       │          │
│ :    proposal     ;                          │           │ Reject │                                       │          │
│  ╲   (BIP/EIP)   ╱                           └───Reject─▶│ Deploy │───────────────────────────────────────┘          │
│   '─.         ,─'                                        └────────┘                                                  │
│      `───────'                                                                                                       │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
</div>
</div>
<p>区块链领域就大大不同了。 即便代码更新的权力在某个组织的手上，但是运行这些代码的人可不一定会听这个组织的指挥，无法容易的命令分散节点统一的进行新代码的部署更新。</p>
<div id="admonition-分布式自治的优缺点" class="admonition tip">
<div class="admonition-title">
<p>分布式自治的优缺点</p>
<p><a class="admonition-anchor-link" href="#admonition-分布式自治的优缺点"></a></p>
</div>
<div>
<p>这是区块链带来的分布式自治的优点，同时也是一个巨大的缺点。</p>
</div>
</div>
<p>比特币社区就是这个领域下的一个典型，由于比特币社区的分裂，部分人并不认同不更改区块大小而是采用隔离见证的方案，分裂出了BCH，对BTC的生态产生的极大的损害。ETH的升级同样也困难重重，每次升级都需要进行长时间的等待以防有节点未升级而产生的分叉。</p>
<p>EOS由于其中心化的特点使得升级稍微简单一些，但仍然出现了由于升级带来的分叉的恶性事件。我们可以形象把区块链下的系统升级称为“全球升级”，因为其要求分布式环境下的大部分节点都更新了代码才使得升级能够成功。相较于中心化控制的系统，区块链系统的升级困难重重且充满风险。</p>
<div id="admonition-高度判断" class="admonition tip">
<div class="admonition-title">
<p>高度判断</p>
<p><a class="admonition-anchor-link" href="#admonition-高度判断"></a></p>
</div>
<div>
<p>同时区块链的升级还有另一个问题：高度判断</p>
<p>一个区块链系统升级后，不得不在代码中加入许多的“高度判断”，以区分不同高度下运行的代码，保证同步能够正常执行，兼容老数据。这种做法很原始但是又无法绕开，给开发者带来极大的思维负担，且需要大量的测试来保证不出现Bug。</p>
</div>
</div>
<p>比如目前比特币的源码中就有许多的区块高度判定使得在同步老区块的时候执行老代码，新区块的时候执行新代码。而中心化系统的数据控制权在自己手上，并且也不存在需要从某个数据源同步的情况，所以完全不需要担心这个问题。</p>
<h4 id="substrate的不同"><a class="header" href="#substrate的不同">Substrate的不同</a></h4>
<p>Substrate横空而出，推出了目前区块链领域最完美的升级方案。其采用“链上代码”的思想，将整个Runtime都做成了可直接更新的组件，让所有节点能够强制运行最新的Runtime代码。</p>
<div id="admonition-substrate-runtime" class="admonition info">
<div class="admonition-title">
<p>Substrate Runtime</p>
<p><a class="admonition-anchor-link" href="#admonition-substrate-runtime"></a></p>
</div>
<div>
<p>简单来说，Runtime在Substrate框架下，将会用同一份代码编译出两份可执行文件：</p>
<ol>
<li>一份Rust的本地代码，我们一般称为native代码，native与其他代码无异，是这个执行文件中的二进制数据，直接运行。在Substrate的相关代码以native命名</li>
<li>一份wasm的链上代码，我们一般成为wasm代码，wasm被部署到链上，所有人可获取，wasm通过构建一个wasm的运行时环境执行 。在Substrate的相关代码以wasm命名 在节点启动的时候可以选择执行策略，使用native, possible，wasm或者both。不同的执行策略会执行不同的执行文件</li>
</ol>
</div>
</div>
<p>由于这两份代码是由相同的代码编译出来的，所以其执行逻辑完全相同 (有一些很小的暗坑要注意)。其中wasm将会部署到链上，所有人都可以获取到，也就是说即使本地运行的不是最新版本的节点，只要同步了区块，一定可以获取到最新的wasm代码。</p>
<p>换句话说，一个写在Runtime内部的代码，也就是代表这条链功能性的代码，存在两份，分别是native与wasm。wasm代码被部署到链上，是“链上数据”，可以通过同步区块所有人统一获取并执行。这样就可以保证在区块链中所有矿工执行的都是最新的代码。</p>
<div id="admonition-哪种更合理" class="admonition tip">
<div class="admonition-title">
<p>哪种更合理</p>
<p><a class="admonition-anchor-link" href="#admonition-哪种更合理"></a></p>
</div>
<div>
<p>这里需要强调，代码的部署可以通过“民主提议”，“sudo控制权限”，“开发者自定一种部署条件”等方式进行，到底哪种方式“更区块链”，“更合理”，不在本文讨论范围内，这与这条链的设计目的相关。Substrate只是提供了这种“热更新”的强大机制，如何使用这种机制是这条链的问题。</p>
</div>
</div>
<h4 id="以太坊合约更新策略"><a class="header" href="#以太坊合约更新策略">以太坊合约更新策略</a></h4>
<div id="admonition-合约更新策略" class="admonition info">
<div class="admonition-title">
<p>合约更新策略</p>
<p><a class="admonition-anchor-link" href="#admonition-合约更新策略"></a></p>
</div>
<div>
<p>我们使用以太坊中“合约更新策略”来解释Substrate的Runtime机制：</p>
</div>
</div>
<p>由于以太坊部署一个合约后，其地址已经被固定，且数据完全存储在这个合约地址下，若这个合约需要升级功能或出现Bug，将会带来许多的问题（比如许多垃圾山寨币的ERC20合约有溢出漏洞，被攻击后损失惨重，只能通过重新部署合约，**
并将老合约的数据重新导入的方式**进行合约升级，且此时的合约地址只能使用新的了）。</p>
<p>许多开发人员不断探索后发展出了如下的以太坊合约升级方式：</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/Substrate_runtime_intro.jpeg" alt="Substrate_runtime_intro" /></p>
<p>熟悉以太坊的开发人员应该很容易理解上图表达的意思。</p>
<p>其核心思想是将一个合约拆分成为“逻辑合约”与“数据合约”，并使用一个“核心合约”将它们串在一起，这个核心合约就是用户的入口。</p>
<p>由于以太坊部署后的地址是固定的，所以将逻辑合约做成一个独立的合约，并将其地址设置在核心合约当中。那么只要更改核心合约中设置的地址，就可以更改核心合约执行的逻辑了。</p>
<p>并且由于以太坊的合约部署后都存在于“世界状态”当中，那么在同步区块时，老数据就会自动使用老的逻辑合约执行，而新的数据使用新的逻辑合约执行。</p>
<div id="admonition-链上代码" class="admonition tip">
<div class="admonition-title">
<p>链上代码</p>
<p><a class="admonition-anchor-link" href="#admonition-链上代码"></a></p>
</div>
<div>
<p>这里的“逻辑合约”就是“链上代码”的概念，它存在于被共识的数据当中，具备历史的意义</p>
</div>
</div>
<h4 id="substrate对应合约更新策略"><a class="header" href="#substrate对应合约更新策略">Substrate对应‘合约更新策略’</a></h4>
<p>那么将Substrate的框架对应过来，其中：</p>
<ul>
<li>“核心合约”的部分就是节点采用wasm执行去从“状态”存储中加载出最新的合约代码</li>
<li>“逻辑合约”的部分就是这条链的Runtime</li>
<li>“数据合约”的部分就是这条链自己的状态数据</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/v2-b9bb441d00298a06de67ab8fdd368c08_720w.jpg" alt="img" /></p>
<div id="admonition-wasm" class="admonition tip">
<div class="admonition-title">
<p>wasm</p>
<p><a class="admonition-anchor-link" href="#admonition-wasm"></a></p>
</div>
<div>
<p>由此可见，由于wasm代码的存在，可以保证即使节点没有更新到最新版本，仍然能够<strong>以最新的代码运行</strong>，保证不会因为代码的不同而分叉。同时在节点同步老数据的过程中也<strong>不会因为本地代码是最新的而导致同步出错</strong></p>
</div>
</div>
<h2 id="项目结构"><a class="header" href="#项目结构">项目结构</a></h2>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/substrate_github.gif" alt="substrate_github" /></p>
<h3 id="客户端架构"><a class="header" href="#客户端架构">客户端架构</a></h3>
<div id="admonition-substrate-client" class="admonition tip">
<div class="admonition-title">
<p>Substrate Client</p>
<p><a class="admonition-anchor-link" href="#admonition-substrate-client"></a></p>
</div>
<div>
<pre><code class="language-text">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃         ___ _   _ ___ ___ _____ ___    _ _____ ___    ___ _    ___ ___ _  _ _____        ┃
┃        / __| | | | _ ) __|_   _| _ \  /_\_   _| __|  / __| |  |_ _| __| \| |_   _|       ┃
┃        \__ \ |_| | _ \__ \ | | |   / / _ \| | | _|  | (__| |__ | || _|| .` | | |         ┃
┃        |___/\___/|___/___/ |_| |_|_\/_/ \_\_| |___|  \___|____|___|___|_|\_| |_|         ┃
┃                                                                                          ┃
┃                                                                                          ┃
┃     ┌───────────────┐     ┌──────────────────────────────────────────────────────────┐   ┃
┃     │               │     │                                                          │   ┃
┃     │               │     │                                                          │   ┃
┃     │               │     │                           RPC                            │   ┃
┃     │               │     │                                                          │   ┃
┃     │      P2P      │     │                                                          │   ┃
┃     │    NETWORK    │     └──────────────────────────────────────────────────────────┘   ┃
┃     │               │     ┌────────────────────────────────────────┐ ┌───────────────┐   ┃
┃     │               │     │                                        │ │               │   ┃
┃     │               │     │            ┌───────────────┐           │ │               │   ┃
┃     │               │     │            │               │           │ │   CONSENSUS   │   ┃
┃     └───────────────┘     │            │     Wasm      │           │ │               │   ┃
┃          .───────.        │            │    Runtime    │           │ │               │   ┃
┃       ,─'         '─.     │            │               │           │ └───────────────┘   ┃
┃      ╱               ╲░   │            └───────────────┘           │                     ┃
┃     ;     NATIVE      :░  │                                        │ ┌───────────────┐   ┃
┃     :     RUNTIME     ;░░ │                                        │ │               │   ┃
┃      ╲               ╱░░░ │                STORAGE                 │ │               │   ┃
┃       ╲             ╱░░░  │                                        │ │   TELEMETRY   │   ┃
┃        '─.       ,─'░░░   │                                        │ │               │   ┃
┃          ░`─────'░░░░░    │                                        │ │               │   ┃
┃             ░░░░░░░       └────────────────────────────────────────┘ └───────────────┘   ┃
┃                                                                                          ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
</code></pre>
</div>
</div>
<h3 id="tree-level1"><a class="header" href="#tree-level1">Tree Level1</a></h3>
<pre><code class="language-shell"> tree -L 1 | pbcopy                                                                                                                                                                                                                        ─╯
.
├── Cargo.lock
├── Cargo.toml
├── HEADER-APACHE2
├── HEADER-GPL3
├── LICENSE-APACHE2
├── LICENSE-GPL3
├── README.md
├── bin
├── client
├── docker
├── docs
├── frame
├── primitives
├── rustfmt.toml
├── scripts
├── shell.nix
├── test-utils
└── utils

9 directories, 9 files
</code></pre>
<h4 id="用cargo组织代码"><a class="header" href="#用cargo组织代码">用Cargo组织代码</a></h4>
<p>Substrate非常明显使用Cargo来组织代码：</p>
<ol>
<li>项目根目录的Cargo.toml会用workspace+members导入各子模块</li>
</ol>
<pre><code class="language-yaml">[ workspace ]
  resolver = &quot;2&quot;

  members = [...]
</code></pre>
<div id="admonition-workspacememgers" class="admonition info">
<div class="admonition-title">
<p>workspace+memgers</p>
<p><a class="admonition-anchor-link" href="#admonition-workspacememgers"></a></p>
</div>
<div>
<p>在[workspace]项下, members 属性表示工作区目录中的程序库列表</p>
</div>
</div>
<ol start="2">
<li>各子模块之间也用Cargo.toml来相互导入使用</li>
</ol>
<pre><code class="language-yaml">[ dependencies ]
  sc-consensus = { version = &quot;0.10.0-dev&quot;, path = &quot;../../client/consensus/common&quot; }
</code></pre>
<div id="admonition-高内聚低耦合" class="admonition tip">
<div class="admonition-title">
<p>高内聚，低耦合</p>
<p><a class="admonition-anchor-link" href="#admonition-高内聚低耦合"></a></p>
</div>
<div>
<p>这里正是通过Cargo.toml的语法，将模块功能内聚之后供调用</p>
</div>
</div>
<h3 id="bin"><a class="header" href="#bin">bin:</a></h3>
<pre><code class="language-shell">tree bin -L 2 | pbcopy                                                                                                                                                                                                                       ─╯
bin
├── node
│   ├── bench
│   ├── cli
│   ├── executor
│   ├── inspect
│   ├── primitives
│   ├── rpc
│   ├── runtime
│   └── testing
├── node-template
│   ├── LICENSE
│   ├── README.md
│   ├── docker-compose.yml
│   ├── docs
│   ├── node
│   ├── pallets
│   ├── runtime
│   ├── scripts
│   └── shell.nix
└── utils
    ├── chain-spec-builder
    └── subkey

18 directories, 4 files
</code></pre>
<h3 id="client"><a class="header" href="#client">client</a></h3>
<pre><code class="language-shell"> tree client -L 1 | pbcopy                                                                                                                                                                                                                    ─╯
client
├── allocator
├── api
├── authority-discovery
├── basic-authorship
├── beefy
├── block-builder
├── chain-spec
├── cli
├── consensus
├── db
├── executor
├── finality-grandpa
├── informant
├── keystore
├── network
├── network-gossip
├── offchain
├── peerset
├── proposer-metrics
├── rpc
├── rpc-api
├── rpc-servers
├── service
├── state-db
├── sync-state-rpc
├── sysinfo
├── telemetry
├── tracing
├── transaction-pool
└── utils

30 directories, 0 files
</code></pre>
<h3 id="frame"><a class="header" href="#frame">FRAME</a></h3>
<div id="admonition-frame" class="admonition info">
<div class="admonition-title">
<p>FRAME</p>
<p><a class="admonition-anchor-link" href="#admonition-frame"></a></p>
</div>
<div>
<p>The Framework for Runtime Aggregation of Modularized Entities (FRAME) is a set of modules and support libraries that simplify runtime development. 
In Substrate , these modules are called Pallets, each hosting domain-specific logic to include in a chain's runtime.</p>
<p>FRAME also provides some helper modules to interact with important Substrate Primitives that provide the interface to the core client.</p>
<p>The following diagram shows the architectural overview of FRAME and its support libraries:</p>
</div>
</div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/frame-arch.png" alt="frame-arch" /></p>
<p><a href="https://docs.substrate.io/v3/runtime/frame/">FRAME | Substrate_</a></p>
<pre><code class="language-shell">tree frame -L 1 | pbcopy
frame
├── alliance: The Alliance Pallet provides a collective that curates a list of accounts and URLs, deemed by the voting members to be unscrupulous actors.
├── assets: A simple, secure module for dealing with fungible assets. The Assets module provides functionality for asset management of fungible asset classes with a fixed supply
├── atomic-swap: A module for atomically sending funds.
├── aura: The Aura module extends Aura consensus by managing offline reporting.
├── authority-discovery: This module is used by the client/authority-discovery to retrieve the current set of authorities.
├── authorship
├── babe
├── bags-list
├── balances: The Balances module provides functionality for handling accounts and balances.
├── beefy
├── beefy-mmr
├── benchmarking
├── bounties
├── child-bounties
├── collective
├── contracts
├── conviction-voting
├── democracy
├── election-provider-multi-phase
├── election-provider-support
├── elections-phragmen
├── examples
├── executive
├── gilt
├── grandpa
├── identity
├── im-online
├── indices
├── lottery
├── membership
├── merkle-mountain-range
├── multisig
├── nicks
├── node-authorization
├── nomination-pools
├── offences
├── preimage
├── proxy
├── randomness-collective-flip
├── ranked-collective
├── recovery
├── referenda
├── remark
├── scheduler
├── scored-pool
├── session
├── society
├── staking
├── state-trie-migration
├── sudo
├── support
├── system
├── timestamp
├── tips
├── transaction-payment
├── transaction-storage
├── treasury
├── try-runtime
├── uniques
├── utility
├── vesting
└── whitelist

62 directories, 0 files

</code></pre>
<h3 id="primitives"><a class="header" href="#primitives">primitives</a></h3>
<pre><code class="language-shell">tree primitives -L 1 | pbcopy
primitives
├── api
├── application-crypto
├── arithmetic
├── authority-discovery
├── authorship
├── beefy
├── block-builder
├── blockchain
├── consensus
├── core
├── database
├── debug-derive
├── externalities
├── finality-grandpa
├── inherents
├── io
├── keyring
├── keystore
├── maybe-compressed-blob
├── merkle-mountain-range
├── npos-elections
├── offchain
├── panic-handler
├── rpc
├── runtime
├── runtime-interface
├── sandbox
├── serializer
├── session
├── staking
├── state-machine
├── std
├── storage
├── tasks
├── test-primitives
├── timestamp
├── tracing
├── transaction-pool
├── transaction-storage-proof
├── trie
├── version
└── wasm-interface

42 directories, 0 files

</code></pre>
<h3 id="scriptsci"><a class="header" href="#scriptsci">scripts/ci</a></h3>
<pre><code class="language-shell">tree scripts/ci | pbcopy
scripts/ci
├── common
│   └── lib.sh
├── deny.toml
├── docker
│   ├── subkey.Dockerfile
│   └── substrate.Dockerfile
├── github
│   ├── check_labels.sh
│   └── generate_changelog.sh
├── gitlab
│   ├── check_runtime.sh
│   ├── check_signed.sh
│   ├── ensure-deps.sh
│   ├── pipeline
│   │   ├── build.yml
│   │   ├── check.yml
│   │   ├── publish.yml
│   │   └── test.yml
│   ├── publish_draft_release.sh
│   └── skip_if_draft.sh
├── monitoring
│   ├── alerting-rules
│   │   ├── alerting-rule-tests.yaml
│   │   └── alerting-rules.yaml
│   └── grafana-dashboards
│       ├── README_dashboard.md
│       ├── substrate-networking.json
│       └── substrate-service-tasks.json
├── node-template-release
│   ├── Cargo.toml
│   └── src
│       └── main.rs
└── node-template-release.sh

10 directories, 23 files

</code></pre>
<h3 id="utils"><a class="header" href="#utils">utils</a></h3>
<pre><code class="language-shell">tree utils -L 1 | pbcopy
utils
├── build-script-utils
├── fork-tree
├── frame
├── prometheus
└── wasm-builder

5 directories, 0 files

</code></pre>
<h2 id="功能逻辑"><a class="header" href="#功能逻辑">功能逻辑</a></h2>
<h2 id="特色代码"><a class="header" href="#特色代码">特色代码</a></h2>
<h2 id="参考资源"><a class="header" href="#参考资源">参考资源</a></h2>
<ul>
<li><a href="https://github.com/paritytech/substrate">paritytech/substrate: Substrate: The platform for blockchain innovators</a></li>
<li><a href="https://docs.substrate.io/v3/getting-started/architecture/">Architecture | Substrate_</a></li>
<li><a href="https://www.zhihu.com/column/c_74315572">链块与分散的数据 - 知乎</a></li>
<li><a href="https://web.archive.org/web/20220618042220/https://zhuanlan.zhihu.com/p/47805322">substrate 源码解析与运用 - 介绍 - 知乎</a></li>
<li><a href="https://www.zhihu.com/column/substrate">Substrate区块链开发 - 知乎</a></li>
<li><a href="https://substrate.io/ecosystem/">Substrate Ecosystem | Substrate_</a></li>
</ul>

            </main>

            <script src="https://utteranc.es/client.js"
                    repo="RustMagazine/rust_magazine_2022"
                    issue-term="title"
                    theme="github-light"
                    crossorigin="anonymous"
                    async></script>

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="../../../../overview.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../../layer1_underlying_abstract/layer1_underlying_abstract.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="../../../../overview.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>
            <a rel="next" href="../../../../layer1_underlying_abstract/layer1_underlying_abstract.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>
    <script src="../../../../ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../searcher.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="../../../../assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="../../../../assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="../../../../assets/smart-anchor.js"></script>
    <script type="text/javascript" src="../../../../assets/pagetoc/sidebar.js"></script>
</body>
</html>
